<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cajas de Ahorro v4</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      getDocs,
      getDoc,
      serverTimestamp,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Configuración Firebase (pegar una sola vez)
    const firebaseConfig = {
      apiKey: "AIzaSyBwzGlQBLecuTfNYvJrOBIX601OySpVHtA",
      authDomain: "registrogastos-7a816.firebaseapp.com",
      projectId: "registrogastos-7a816",
      storageBucket: "registrogastos-7a816.firebasestorage.app",
      messagingSenderId: "758483224724",
      appId: "1:758483224724:web:f04068b22eab2a2c3f4c81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Colecciones
    const cajasCol = collection(db, 'cajas');
    const distribCol = collection(db, 'distribuciones');

    // Vistas y estado
    const mainView = document.getElementById('main-view');
    const boxDetailView = document.getElementById('box-detail-view');
    const boxesList = document.getElementById('boxes-list');
    const boxTitle = document.getElementById('box-title');
    const boxActions = document.getElementById('box-actions');
    const txnTable = document.getElementById('txn-table-body');
    const totalDisplay = document.getElementById('box-total');
    const addTxnBtn = document.getElementById('open-txn-form');
    const txnModal = document.getElementById('transaction-modal');
    const txnForm = document.getElementById('transaction-form');
    const budgetForm = document.getElementById('budget-form');
    const budgetInput = document.getElementById('budget-input');
    const budgetDisplay = document.getElementById('box-budget');
    let currentBoxId = null;

    // Fecha actual
    document.getElementById('current-date').textContent = new Date().toLocaleDateString();

    // Mostrar vista
    function showView(view) {
      mainView.style.display = view === 'main' ? 'block' : 'none';
      boxDetailView.style.display = view === 'detail' ? 'block' : 'none';
    }
    showView('main');

    // Render cajas
    function renderCajas() {
      onSnapshot(cajasCol, snapshot => {
        boxesList.innerHTML = '';
        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const li = document.createElement('li');
          const meta = data.budget ? ` (Meta: $${data.budget})` : '';
          li.textContent = `${data.nombre}: $${data.saldo.toFixed(2)}${meta}`;
          li.style.cursor = 'pointer';
          li.onclick = () => openBoxDetail(docSnap.id, data);
          boxesList.appendChild(li);
        });
      });
    }

    // Crear nueva caja
    document.getElementById('create-box-btn').onclick = async () => {
      const nombre = prompt('Nombre de la nueva caja:');
      if (nombre) await addDoc(cajasCol, { nombre: nombre.trim(), saldo: 0, budget: 0, fechaCreacion: serverTimestamp() });
    };

    // Abrir detalle de caja
    async function openBoxDetail(id, data) {
      currentBoxId = id;
      showView('detail');
      boxTitle.textContent = '';
      boxActions.innerHTML = '';

      // Título y acciones editar/eliminar
      const titleSpan = document.createElement('span');
      titleSpan.textContent = data.nombre;
      boxActions.appendChild(titleSpan);
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Editar Caja';
      editBtn.onclick = async () => {
        const nuevo = prompt('Nuevo nombre:', data.nombre);
        if (nuevo) await updateDoc(doc(db,'cajas',id), { nombre: nuevo.trim() });
      };
      boxActions.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Eliminar Caja';
      delBtn.onclick = async () => {
        if (confirm('¿Eliminar esta caja y todo su contenido?')) {
          await deleteDoc(doc(db,'cajas',id));
          showView('main');
        }
      };
      boxActions.appendChild(delBtn);

      // Mostrar presupuesto/meta
      budgetDisplay.textContent = `$${data.budget.toFixed(2)}`;
      budgetForm.onsubmit = async e => {
        e.preventDefault();
        const newBudget = parseFloat(budgetInput.value);
        if (!isNaN(newBudget)) await updateDoc(doc(db,'cajas',id), { budget: newBudget });
      };

      // Transacciones
      const transCol = collection(db, `cajas/${id}/transacciones`);
      const q = query(transCol, orderBy('fecha','desc'));
      onSnapshot(q, snap => {
        txnTable.innerHTML = '';
        snap.docs.forEach(txnSnap => {
          const d = txnSnap.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(d.fecha.toDate()).toLocaleDateString()}</td>
            <td>${d.tipo.toUpperCase()}</td>
            <td>$${d.monto.toFixed(2)}</td>
            <td>${d.descripcion}</td>
            <td><button data-id="${txnSnap.id}" class="del-txn-btn">Eliminar</button></td>
          `;
          txnTable.appendChild(row);
        });
        // Total y delegar eliminación
        getDoc(doc(db,'cajas',id)).then(snapCaja => {
          totalDisplay.textContent = `$${snapCaja.data().saldo.toFixed(2)}`;
          budgetDisplay.textContent = `$${snapCaja.data().budget.toFixed(2)}`;
        });
        document.querySelectorAll('.del-txn-btn').forEach(btn => btn.onclick = async () => {
          if (confirm('Eliminar transacción?')) {
            const txnId = btn.dataset.id;
            const txnSnap = snap.docs.find(x=>x.id===txnId).data();
            await deleteDoc(doc(db, `cajas/${id}/transacciones`, txnId));
            const adj = txnSnap.tipo==='ingreso' ? -txnSnap.monto : txnSnap.monto;
            const cajaRef = doc(db,'cajas',id);
            const cajaSnap = await getDoc(cajaRef);
            await updateDoc(cajaRef, { saldo: cajaSnap.data().saldo + adj });
          }
        });
      });
    }

    // Agregar transacción
    addTxnBtn.onclick = () => txnModal.style.display='block';
    txnForm.onsubmit = async e => {
      e.preventDefault();
      const tipo = e.target.tipo.value;
      const monto = parseFloat(e.target.monto.value);
      const desc = e.target.descripcion.value.trim();
      const cajaRef = doc(db,'cajas',currentBoxId);
      const cajaSnap = await getDoc(cajaRef);
      const nuevoSaldo = tipo==='ingreso' ? cajaSnap.data().saldo + monto : cajaSnap.data().saldo - monto;
      await updateDoc(cajaRef,{ saldo: nuevoSaldo });
      const transCol = collection(db, `cajas/${currentBoxId}/transacciones`);
      await addDoc(transCol,{ tipo, monto, descripcion: desc, fecha: serverTimestamp() });
      txnForm.reset(); txnModal.style.display='none';
    };

    // Volver
    document.querySelectorAll('.back-btn').forEach(btn=>btn.onclick=()=>showView('main'));
    renderCajas();
  </script>
  <style>
    body{font-family:Arial,sans-serif;margin:20px}
    button{margin:4px;padding:6px}
    section{display:none}
    #main-view{display:block}
    ul{list-style:none;padding:0}
    li{margin:6px 0;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:6px;text-align:left}
    #transaction-modal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#f9f9f9;padding:20px;border:1px solid #ccc}
    form{margin-top:10px}
    label,input,select{display:block;margin:6px 0;width:100%;padding:4px}
  </style>
</head>
<body>
  <h1>Cajas de Ahorro v4</h1>
  <div>Fecha: <span id="current-date"></span></div>

  <section id="main-view">
    <button id="create-box-btn">Nueva Caja</button>
    <ul id="boxes-list"></ul>
  </section>

  <section id="box-detail-view">
    <button class="back-btn">« Volver</button>
    <h2 id="box-title"></h2>
    <div id="box-actions"></div>
    <div>Total: <strong id="box-total"></strong></div>
    <form id="budget-form">
      <label>Meta/Presupuesto:<input id="budget-input" type="number" placeholder="0"/></label>
      <button type="submit">Guardar Meta</button>
      <div>Meta actual: <strong id="box-budget"></strong></div>
    </form>
    <button id="open-txn-form">Agregar Transacción</button>
    <table>
      <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Desc</th><th>Acción</th></tr></thead>
      <tbody id="txn-table-body"></tbody>
    </table>

    <div id="transaction-modal">
      <form id="transaction-form">
        <button class="back-btn" type="button" onclick="transaction-modal.style.display='none'">Cerrar</button>
        <label>Tipo<select name="tipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select></label>
        <label>Monto<input name="monto" type="number" step="0.01"/></label>
        <label>Desc<input name="descripcion"/></label>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </section>
</body>
</html>


