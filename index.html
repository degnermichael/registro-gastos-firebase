<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cajas de Ahorro v3</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      getDocs,
      getDoc,
      serverTimestamp,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Configuración Firebase (pegar una sola vez)
    const firebaseConfig = {
      apiKey: "AIzaSyBwzGlQBLecuTfNYvJrOBIX601OySpVHtA",
      authDomain: "registrogastos-7a816.firebaseapp.com",
      projectId: "registrogastos-7a816",
      storageBucket: "registrogastos-7a816.firebasestorage.app",
      messagingSenderId: "758483224724",
      appId: "1:758483224724:web:f04068b22eab2a2c3f4c81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Colecciones
    const cajasCol = collection(db, 'cajas');
    const distribCol = collection(db, 'distribuciones');

    // Vistas y estado
    const mainView = document.getElementById('main-view');
    const boxDetailView = document.getElementById('box-detail-view');
    const boxesList = document.getElementById('boxes-list');
    const boxTitle = document.getElementById('box-title');
    const txnTable = document.getElementById('txn-table-body');
    const totalDisplay = document.getElementById('box-total');
    const addTxnBtn = document.getElementById('open-txn-form');
    const txnForm = document.getElementById('transaction-form');
    const txnModal = document.getElementById('transaction-modal');
    let currentBoxId = null;

    // Fecha actual
    document.getElementById('current-date').textContent = new Date().toLocaleDateString();

    // Mostrar vista
    function showView(view) {
      mainView.style.display = view === 'main' ? 'block' : 'none';
      boxDetailView.style.display = view === 'detail' ? 'block' : 'none';
    }
    showView('main');

    // Render cajas
    function renderCajas() {
      onSnapshot(cajasCol, snapshot => {
        boxesList.innerHTML = '';
        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const li = document.createElement('li');
          li.textContent = `${data.nombre}: $${data.saldo.toFixed(2)}`;
          li.style.cursor = 'pointer';
          li.onclick = () => openBoxDetail(docSnap.id, data.nombre);
          boxesList.appendChild(li);
        });
      });
    }

    // Crear nueva caja
    document.getElementById('create-box-btn').onclick = async () => {
      const nombre = prompt('Nombre de la nueva caja:');
      if (nombre) await addDoc(cajasCol, { nombre: nombre.trim(), saldo: 0, fechaCreacion: serverTimestamp() });
    };

    // Distribuir ingreso
    document.getElementById('distribute-btn').onclick = async () => {
      const total = parseFloat(prompt('Monto total a distribuir:'));
      if (isNaN(total)) return alert('Monto inválido');
      const docs = (await getDocs(cajasCol)).docs;
      if (!docs.length) return alert('No hay cajas para distribuir');
      const detalle = [];
      for (const box of docs) {
        const pct = parseFloat(prompt(`Porcentaje para caja "${box.data().nombre}" (%):`));
        if (isNaN(pct) || pct < 0) return alert('Porcentaje inválido');
        const asignado = total * pct / 100;
        await updateDoc(doc(db,'cajas',box.id), { saldo: box.data().saldo + asignado });
        detalle.push({ cajaId: box.id, porcentaje: pct, montoAsignado: asignado });
      }
      await addDoc(distribCol, { fecha: serverTimestamp(), montoTotal: total, detalle });
    };

    // Abrir detalle de caja
    function openBoxDetail(id, nombre) {
      currentBoxId = id;
      boxTitle.textContent = nombre;
      showView('detail');
      const transCol = collection(db, `cajas/${id}/transacciones`);
      const q = query(transCol, orderBy('fecha','desc'));
      onSnapshot(q, snap => {
        // Actualizar tabla
        txnTable.innerHTML = '';
        snap.docs.forEach(txnSnap => {
          const d = txnSnap.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(d.fecha.toDate()).toLocaleDateString()}</td>
            <td>${d.tipo.toUpperCase()}</td>
            <td>$${d.monto.toFixed(2)}</td>
            <td>${d.descripcion}</td>
            <td><button data-id="${txnSnap.id}" class="del-txn-btn">Eliminar</button></td>
          `;
          txnTable.appendChild(row);
        });
        // Total disponible
        getDoc(doc(db,'cajas',id)).then(snapCaja => {
          totalDisplay.textContent = `$${snapCaja.data().saldo.toFixed(2)}`;
        });
        // Delegación de eliminación
        document.querySelectorAll('.del-txn-btn').forEach(btn => {
          btn.onclick = async () => {
            if (confirm('Eliminar esta transacción?')) {
              await deleteDoc(doc(db, `cajas/${id}/transacciones`, btn.dataset.id));
              // Ajustar saldo
              const dSnap = snap.docs.find(x=>x.id===btn.dataset.id).data();
              const cajaRef = doc(db,'cajas',id);
              const cajaSnap = await getDoc(cajaRef);
              const saldoAct = cajaSnap.data().saldo;
              const ajuste = dSnap.tipo==='ingreso' ? -dSnap.monto : dSnap.monto;
              await updateDoc(cajaRef,{ saldo: saldoAct + ajuste });
            }
          };
        });
      });
    }

    // Agregar transacción
    addTxnBtn.onclick = () => txnModal.style.display='block';
    txnForm.onsubmit = async e => {
      e.preventDefault();
      const tipo = e.target.tipo.value;
      const monto = parseFloat(e.target.monto.value);
      const desc = e.target.descripcion.value.trim();
      if (isNaN(monto)) return alert('Monto inválido');
      const cajaRef = doc(db,'cajas',currentBoxId);
      const cajaSnap = await getDoc(cajaRef);
      const nuevoSaldo = tipo==='ingreso' ? cajaSnap.data().saldo + monto : cajaSnap.data().saldo - monto;
      await updateDoc(cajaRef,{ saldo: nuevoSaldo });
      const transCol = collection(db, `cajas/${currentBoxId}/transacciones`);
      await addDoc(transCol,{ tipo, monto, descripcion: desc, fecha: serverTimestamp() });
      e.target.reset();
      txnModal.style.display='none';
    };

    // Botón volver
    document.querySelectorAll('.back-btn').forEach(btn => btn.onclick = () => showView('main'));

    // Iniciar
    renderCajas();
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { padding: 4px 8px; margin: 2px; }
    section { display: none; }
    #main-view { display: block; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    #transaction-modal { display: none; position: fixed; top:20%; left:50%; transform:translateX(-50%); background: #f9f9f9; padding: 20px; border: 1px solid #ccc; }
    label, select, input { display: block; margin: 6px 0; width: 100%; padding: 4px; }
  </style>
</head>
<body>
  <h1>Cajas de Ahorro v3</h1>
  <div>Fecha actual: <span id="current-date"></span></div>

  <section id="main-view">
    <nav>
      <button id="create-box-btn">Nueva Caja</button>
      <button id="distribute-btn">Distribuir Ingreso</button>
    </nav>
    <ul id="boxes-list"></ul>
  </section>

  <section id="box-detail-view">
    <button class="back-btn">« Volver</button>
    <h2 id="box-title"></h2>
    <div>Total disponible: <strong id="box-total"></strong></div>
    <button id="open-txn-form">Agregar Transacción</button>
    <table>
      <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Descripción</th><th>Acción</th></tr></thead>
      <tbody id="txn-table-body"></tbody>
    </table>
    <div id="transaction-modal">
      <form id="transaction-form">
        <button class="back-btn" type="button" onclick="txnModal.style.display='none'">Cerrar</button>
        <label>Tipo:
          <select name="tipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select>
        </label>
        <label>Monto:<input name="monto" type="number" step="0.01" required /></label>
        <label>Descripción:<input name="descripcion" required /></label>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </section>
</body>
</html>

