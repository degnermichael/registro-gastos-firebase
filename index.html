<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cajas de Ahorro v6</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      getDoc,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwzGlQBLecuTfNYvJrOBIX601OySpVHtA",
      authDomain: "registrogastos-7a816.firebaseapp.com",
      projectId: "registrogastos-7a816",
      storageBucket: "registrogastos-7a816.firebasestorage.app",
      messagingSenderId: "758483224724",
      appId: "1:758483224724:web:f04068b22eab2a2c3f4c81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const cajasCol = collection(db, "cajas");
    const distribCol = collection(db, "distribuciones");

    let cajas = [];
    let currentBoxId = null;

    // UI elements
    const mainView = document.getElementById("main-view");
    const detailView = document.getElementById("box-detail-view");
    const boxesContainer = document.getElementById("boxes-container");
    const boxTitle = document.getElementById("box-title");
    const boxActions = document.getElementById("box-actions");
    const totalDisplay = document.getElementById("box-total");
    const budgetInput = document.getElementById("budget-input");
    const budgetForm = document.getElementById("budget-form");
    const txnTable = document.getElementById("txn-table-body");
    const txnModal = document.getElementById("transaction-modal");
    const txnForm = document.getElementById("transaction-form");

    // Mostrar fecha actual
    document.getElementById("current-date").textContent = new Date().toLocaleDateString();

    function showView(view) {
      mainView.style.display = view === 'main' ? 'block' : 'none';
      detailView.style.display = view === 'detail' ? 'block' : 'none';
    }
    showView('main');

    // Render cajas con inputs y botones
    function renderMain() {
      onSnapshot(cajasCol, snapshot => {
        cajas = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        boxesContainer.innerHTML = '';
        cajas.forEach(box => {
          const row = document.createElement('div');
          row.className = 'box-row';
          row.innerHTML = `
            <span class="box-name">${box.nombre}</span>
            <span class="box-saldo">$${box.saldo.toFixed(2)}</span>
            <input type="number" min="0" placeholder="%" class="pct-input" data-id="${box.id}" />
            <input type="number" min="0" placeholder="Monto" class="amt-input" data-id="${box.id}" />
            <button class="apply-btn" data-id="${box.id}">Aplicar</button>
          `;
          boxesContainer.appendChild(row);
        });
        // Attach listeners
        document.querySelectorAll('.apply-btn').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const pct = parseFloat(document.querySelector(`.pct-input[data-id="${id}"]`).value) || 0;
            const amt = parseFloat(document.querySelector(`.amt-input[data-id="${id}"]`).value) || 0;
            // Calculate based on either pct or direct amt
            let amountToAdd = amt;
            if (pct > 0) {
              const total = parseFloat(document.getElementById('amt-input').value) || 0;
              amountToAdd = (total * pct) / 100;
            }
            const boxRef = doc(db, 'cajas', id);
            const boxSnap = await getDoc(boxRef);
            const newSaldo = (boxSnap.data().saldo || 0) + amountToAdd;
            await updateDoc(boxRef, { saldo: newSaldo });
            await addDoc(collection(db, `cajas/${id}/transacciones`), {
              tipo: 'manual',
              monto: amountToAdd,
              descripcion: 'Aplicación individual',
              fecha: serverTimestamp()
            });
            renderMain();
          };
        });
      });
    }

    // Funciones detalle caja y transacciones permanecen igual
    function openDetail(id, data) {
      currentBoxId = id; showView('detail');
      // Setup actions, budget, txn table...
      boxTitle.textContent = data.nombre;
      // ... rest of detail logic
    }

    document.getElementById('create-box-btn').onclick = async () => {
      const nombre = prompt('Nombre de la nueva caja:');
      if (nombre) await addDoc(cajasCol, { nombre: nombre.trim(), saldo: 0, budget: 0, fechaCreacion: serverTimestamp() });
    };

    // Init
    renderMain();
  </script>
  <style>
    .box-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
    .box-name, .box-saldo { width: 100px; }
    .pct-input, .amt-input { width: 60px; }
  </style>
</head>
<body>
  <h1>Cajas de Ahorro v6</h1>
  <div>Fecha: <span id="current-date"></span></div>
  <section id="main-view">
    <button id="create-box-btn">Nueva Caja</button>
    <h2>Cajas</h2>
    <div id="boxes-container"></div>
    <div>
      <label>Distribución global: <input id="amt-input" type="number" placeholder="Monto total" /></label>
    </div>
  </section>
  <section id="box-detail-view">
    <!-- detail view content -->
  </section>
</body>
</html>






