<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cajas de Ahorro v2</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      getDocs,
      getDoc,
      serverTimestamp,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Configuración Firebase (pegar una sola vez)
    const firebaseConfig = {
      apiKey: "AIzaSyBwzGlQBLecuTfNYvJrOBIX601OySpVHtA",
      authDomain: "registrogastos-7a816.firebaseapp.com",
      projectId: "registrogastos-7a816",
      storageBucket: "registrogastos-7a816.firebasestorage.app",
      messagingSenderId: "758483224724",
      appId: "1:758483224724:web:f04068b22eab2a2c3f4c81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Colecciones
    const cajasCol = collection(db, 'cajas');
    const distribCol = collection(db, 'distribuciones');

    // Vistas y estado
    const mainView = document.getElementById('main-view');
    const boxDetailView = document.getElementById('box-detail-view');
    const boxesList = document.getElementById('boxes-list');
    const boxTitle = document.getElementById('box-title');
    const txnList = document.getElementById('txn-list');
    const transactionModal = document.getElementById('transaction-modal');
    const transactionForm = document.getElementById('transaction-form');
    let currentBoxId = null;

    // Fecha actual
    document.getElementById('current-date').textContent = new Date().toLocaleDateString();

    // Muestra vista
    function showView(view) {
      mainView.style.display = view === 'main' ? 'block' : 'none';
      boxDetailView.style.display = view === 'detail' ? 'block' : 'none';
    }
    showView('main');

    // Render cajas con editar/eliminar
    function renderCajas() {
      onSnapshot(cajasCol, snapshot => {
        boxesList.innerHTML = '';
        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          const li = document.createElement('li');
          // Nombre y saldo
          const span = document.createElement('span');
          span.textContent = `${data.nombre}: $${data.saldo.toFixed(2)}`;
          span.style.cursor = 'pointer';
          span.onclick = () => openBoxDetail(docSnap.id, data.nombre);
          li.appendChild(span);
          // Editar
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Editar';
          editBtn.onclick = async () => {
            const nuevo = prompt('Nuevo nombre de la caja:', data.nombre);
            if (nuevo) await updateDoc(doc(db,'cajas',docSnap.id),{nombre: nuevo.trim()});
          };
          li.appendChild(editBtn);
          // Eliminar
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Eliminar';
          delBtn.onclick = async () => {
            if (confirm(`¿Eliminar caja "${data.nombre}" y todas sus transacciones?`)) {
              await deleteDoc(doc(db,'cajas',docSnap.id));
            }
          };
          li.appendChild(delBtn);
          boxesList.appendChild(li);
        });
      });
    }

    // Crear nueva caja
    document.getElementById('create-box-btn').onclick = async () => {
      const nombre = prompt('Nombre de la nueva caja:');
      if (nombre) await addDoc(cajasCol, { nombre: nombre.trim(), saldo: 0, fechaCreacion: serverTimestamp() });
    };

    // // Distribuir ingreso con porcentaje individual
    document.getElementById('distribute-btn').onclick = async () => {
      const total = parseFloat(prompt('Monto total a distribuir:'));
      if (isNaN(total)) return alert('Monto inválido');
      const docs = (await getDocs(cajasCol)).docs;
      if (!docs.length) return alert('No hay cajas para distribuir');
      const detalle = [];
      for (const box of docs) {
        const nombreBox = box.data().nombre;
        const pct = parseFloat(prompt(`Porcentaje para caja "${nombreBox}" (%) :`));
        if (isNaN(pct) || pct < 0) return alert('Porcentaje inválido para ' + nombreBox);
        const asignado = total * pct / 100;
        // Actualizar saldo
        await updateDoc(doc(db,'cajas',box.id), { saldo: box.data().saldo + asignado });
        detalle.push({ cajaId: box.id, porcentaje: pct, montoAsignado: asignado });
      }
      // Guardar distribución
      await addDoc(distribCol, { fecha: serverTimestamp(), montoTotal: total, detalle });
    };


    // Abrir detalle de caja
    async function openBoxDetail(id, nombre) {
      currentBoxId = id;
      boxTitle.textContent = nombre;
      showView('detail');
      const transCol = collection(db, `cajas/${id}/transacciones`);
      const q = query(transCol, orderBy('fecha','desc'));
      onSnapshot(q, snap => {
        txnList.innerHTML = '';
        snap.docs.forEach(txn => {
          const d = txn.data();
          const li = document.createElement('li');
          li.textContent = `${new Date(d.fecha.toDate()).toLocaleDateString()} - ${d.tipo.toUpperCase()}: $${d.monto.toFixed(2)} (${d.descripcion})`;
          txnList.appendChild(li);
        });
      });
    }

    // Guardar transacción
    transactionForm.onsubmit = async e => {
      e.preventDefault();
      const tipo = e.target.tipo.value;
      const monto = parseFloat(e.target.monto.value);
      const desc = e.target.descripcion.value.trim();
      if (!currentBoxId || isNaN(monto)) return alert('Datos inválidos');
      // Obtener saldo actual
      const cajaRef = doc(db,'cajas',currentBoxId);
      const cajaSnap = await getDoc(cajaRef);
      const saldoActual = cajaSnap.exists() ? cajaSnap.data().saldo : 0;
      const nuevoSaldo = tipo === 'ingreso' ? saldoActual + monto : saldoActual - monto;
      // Actualizar caja y registrar transacción
      await updateDoc(cajaRef, { saldo: nuevoSaldo });
      const transCol = collection(db, `cajas/${currentBoxId}/transacciones`);
      await addDoc(transCol, { tipo, monto, descripcion: desc, fecha: serverTimestamp() });
      transactionModal.style.display = 'none';
      e.target.reset();
    };

    // Botón regresar
    document.querySelectorAll('.back-btn').forEach(btn => btn.onclick = () => showView('main'));

    // Inicializar
    renderCajas();
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin-left: 6px; padding: 4px 8px; }
    section { display: none; }
    #main-view { display: block; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; }
    #transaction-modal { display: none; background: #eee; padding: 10px; position: fixed; top:20%; left:50%; transform:translateX(-50%); }
    label, select, input { display: block; margin: 6px 0; }
    input, select { padding: 6px; width: 100%; }
  </style>
</head>
<body>
  <h1>Cajas de Ahorro v2</h1>
  <div>Fecha actual: <span id="current-date"></span></div>

  <section id="main-view">
    <nav>
      <button id="create-box-btn">Nueva Caja</button>
      <button id="distribute-btn">Distribuir Ingreso</button>
    </nav>
    <ul id="boxes-list"></ul>
  </section>

  <section id="box-detail-view">
    <button class="back-btn">« Volver</button>
    <h2 id="box-title"></h2>
    <button onclick="transactionModal.style.display='block'">Agregar Transacción</button>
    <ul id="txn-list"></ul>

    <div id="transaction-modal">
      <form id="transaction-form">
        <button class="back-btn" type="button" onclick="transactionModal.style.display='none'">Cerrar</button>
        <label>Tipo:
          <select name="tipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select>
        </label>
        <label>Monto:<input name="monto" type="number" step="0.01" required /></label>
        <label>Descripción:<input name="descripcion" required /></label>
        <button type="submit">Guardar</button>
      </form>
    </div>
  </section>
</body>
</html>
