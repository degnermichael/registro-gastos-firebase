<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cajas de Ahorro v4-5</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      deleteDoc,
      getDocs,
      getDoc,
      serverTimestamp,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBwzGlQBLecuTfNYvJrOBIX601OySpVHtA",
      authDomain: "registrogastos-7a816.firebaseapp.com",
      projectId: "registrogastos-7a816",
      storageBucket: "registrogastos-7a816.firebasestorage.app",
      messagingSenderId: "758483224724",
      appId: "1:758483224724:web:f04068b22eab2a2c3f4c81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Colecciones
    const cajasCol = collection(db, 'cajas');
    const distribCol = collection(db, 'distribuciones');

    // Estado
    let currentBoxId = null;
    let cajas = [];

    // Elementos UI
    const mainView = document.getElementById('main-view');
    const detailView = document.getElementById('box-detail-view');
    const boxesList = document.getElementById('boxes-list');
    const pctInputs = document.getElementById('pct-inputs');
    const amtInput = document.getElementById('amt-input');
    const calcResults = document.getElementById('calc-results');
    const boxTitle = document.getElementById('box-title');
    const boxActions = document.getElementById('box-actions');
    const totalDisplay = document.getElementById('box-total');
    const budgetDisplay = document.getElementById('box-budget');
    const txnTable = document.getElementById('txn-table-body');
    const txnModal = document.getElementById('transaction-modal');
    const txnForm = document.getElementById('transaction-form');
    const budgetForm = document.getElementById('budget-form');

    // Mostrar fecha
    document.getElementById('current-date').textContent = new Date().toLocaleDateString();

    // Navegación vistas
    function showView(name) {
      mainView.style.display = name==='main' ? 'block' : 'none';
      detailView.style.display = name==='detail' ? 'block' : 'none';
    }
    showView('main');

    // Render principal con creación y %, v4+v5
    function renderMain() {
      onSnapshot(cajasCol, snapshot => {
        cajas = snapshot.docs.map(d=>({id:d.id,...d.data()}));
        boxesList.innerHTML = '';
        pctInputs.innerHTML = '';
        snapshot.docs.forEach(docSnap => {
          const data = docSnap.data();
          // Lista de cajas con click detail
          const li = document.createElement('li');
          const meta = data.budget?` (Meta: $${data.budget})`:'';
          li.textContent = `${data.nombre}: $${data.saldo.toFixed(2)}${meta}`;
          li.style.cursor='pointer'; li.onclick=()=>openDetail(docSnap.id,data);
          boxesList.appendChild(li);
          // Input %
          const inp = document.createElement('input'); inp.type='number'; inp.min=0; inp.max=100;
          inp.placeholder=`% ${data.nombre}`; inp.dataset.id=docSnap.id;
          inp.oninput=calculate;
          pctInputs.appendChild(inp);
        });
      });
    }

    // Crear nueva caja
    document.getElementById('create-box-btn').onclick = async () => {
      const nombre = prompt('Nombre de la nueva caja:');
      if (nombre) await addDoc(cajasCol, { nombre: nombre.trim(), saldo: 0, budget: 0, fechaCreacion: serverTimestamp() });
    };

    // Calcular reparto
    function calculate(){
      calcResults.innerHTML=''; const total=parseFloat(amtInput.value);
      if(isNaN(total)) return;
      let sum=0;
      cajas.forEach(b=>{
        const inp=pctInputs.querySelector(`input[data-id="${b.id}"]`);
        const pct=parseFloat(inp.value)||0; sum+=pct;
        const m=total*pct/100;
        const div=document.createElement('div');
        div.textContent=`${b.nombre}: ${pct}% → $${m.toFixed(2)}`;
        calcResults.appendChild(div);
      });
      const acc=document.createElement('div'); acc.textContent=`Total %: ${sum.toFixed(2)}%`;
      calcResults.appendChild(acc);
    }

    // Distribuir y registrar en transacciones
    document.getElementById('distribute-btn').onclick=async()=>{
      const total=parseFloat(amtInput.value);
      if(isNaN(total))return alert('Monto inválido');
      const detalle=[];
      for(const b of cajas){
        const inp=pctInputs.querySelector(`input[data-id="${b.id}"]`);
        const pct=parseFloat(inp.value)||0; const m=total*pct/100;
        await updateDoc(doc(db,'cajas',b.id),{saldo:b.saldo+m});
        // registrar transacción de distribución
        await addDoc(collection(db,`cajas/${b.id}/transacciones`),{tipo:'distribución',monto:m,descripcion:'Distribución global',fecha:serverTimestamp()});
        detalle.push({cajaId:b.id,porcentaje:pct,montoAsignado:m});
      }
      await addDoc(distribCol,{fecha:serverTimestamp(),montoTotal:total,detalle});
      amtInput.value='';pctInputs.querySelectorAll('input').forEach(i=>i.value='');calcResults.innerHTML='Distribuido';
    };

    // Abrir detalle de caja
    function openDetail(id,data){
      currentBoxId=id; showView('detail');
      // Acciones editar/eliminar caja
      boxTitle.textContent=data.nombre;
      boxActions.innerHTML='';
      const editBtn=document.createElement('button'); editBtn.textContent='Editar Caja';
      editBtn.onclick=async()=>{const n=prompt('Nuevo nombre',data.nombre);if(n)await updateDoc(doc(db,'cajas',id),{nombre:n.trim()});};
      const delBtn=document.createElement('button'); delBtn.textContent='Eliminar Caja';
      delBtn.onclick=async()=>{if(confirm('Eliminar?')){await deleteDoc(doc(db,'cajas',id));showView('main');}};
      boxActions.append(editBtn,delBtn);
      // Mostrar presupuesto
      budgetDisplay.textContent=`$${data.budget.toFixed(2)}`;
      budgetForm.onsubmit=async e=>{e.preventDefault();const v=parseFloat(document.getElementById('budget-input').value);if(!isNaN(v))await updateDoc(doc(db,'cajas',id),{budget:v});};
      // Transacciones y total
      const col=collection(db,`cajas/${id}/transacciones`);
      const q=query(col,orderBy('fecha','desc'));
      onSnapshot(q,snap=>{
        txnTable.innerHTML='';
        snap.docs.forEach(txn=>{const d=txn.data();
          const tr=document.createElement('tr'); tr.innerHTML=
            `<td>${new Date(d.fecha.toDate()).toLocaleDateString()}</td>`+
            `<td>${d.tipo}</td><td>$${d.monto.toFixed(2)}</td><td>${d.descripcion}</td>`+
            `<td><button data-id="${txn.id}" class="del">Eliminar</button></td>`;
          txnTable.append(tr);
        });
        // actualizar saldos y presupuestos
        getDoc(doc(db,'cajas',id)).then(cs=>{totalDisplay.textContent=`$${cs.data().saldo.toFixed(2)}`;budgetDisplay.textContent=`$${cs.data().budget.toFixed(2)}`;});
        // eliminar transacción
        txnTable.querySelectorAll('.del').forEach(btn=>btn.onclick=async()=>{if(confirm('Eliminar transacción?')){const tid=btn.dataset.id;const d=snap.docs.find(x=>x.id===tid).data();await deleteDoc(doc(db,`cajas/${id}/transacciones`,tid));const ref=doc(db,'cajas',id);const csnap=await getDoc(ref);const newBal=d.tipo==='ingreso'?csnap.data().saldo-d.monto:csnap.data().saldo+d.monto;await updateDoc(ref,{saldo:newBal});}});
      });
    }

    // Guardar transacción manual
    txnForm.onsubmit=async e=>{e.preventDefault();const t=e.target.tipo.value,m=parseFloat(e.target.monto.value),desc=e.target.descripcion.value.trim();const cref=doc(db,'cajas',currentBoxId),cs=await getDoc(cref),nb=t==='ingreso'?cs.data().saldo+m:cs.data().saldo-m;await updateDoc(cref,{saldo:nb});await addDoc(collection(db,`cajas/${currentBoxId}/transacciones`),{tipo:t,monto:m,descripcion:desc,fecha:serverTimestamp()});e.target.reset();txnModal.style.display='none';};

    // Botón volver
    document.querySelectorAll('[onclick*="showView"]').forEach(btn=>btn.onclick=()=>showView('main'));

    // Init
    renderMain();
  </script>
  <style>
    body{font-family:Arial,sans-serif;margin:20px}
    button,input{margin:4px;padding:6px}
    section{display:none}#main-view{display:block}
    ul{list-style:none;padding:0}li{cursor:pointer;margin:6px 0}
    table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ccc;padding:6px}
    #transaction-modal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#f9f9f9;padding:20px;border:1px solid #ccc}
    form{margin-top:10px}label,select,input{display:block;width:100%;margin:6px 0;padding:4px}
  </style>
</head>
<body>
  <h1>Cajas de Ahorro v4-5</h1>
  <div>Fecha: <span id="current-date"></span></div>

  <!-- Vista Principal -->
  <section id="main-view">
    <button id="create-box-btn">Nueva Caja</button>
    <h2>Cajas</h2>
    <ul id="boxes-list"></ul>
    <h3>Distribuir Ingreso</h3>
    <input id="amt-input" type="number" placeholder="Monto total" />
    <div id="pct-inputs"></div>
    <button onclick="calculate()">Calcular</button>
    <button id="distribute-btn">Distribuir</button>
    <div id="calc-results"></div>
  </section>

  <!-- Vista Detalle Caja -->
  <section id="box-detail-view">
    <button onclick="showView('main')">« Volver</button>
    <h2 id="box-title"></h2>
    <div id="box-actions"></div>
    <div>Total: <strong id="box-total"></strong></div>
    <form id="budget-form">
      <label>Meta:<input id="budget-input" type="number"/></label>
      <button type="submit">Guardar Meta</button>
      <div>Meta actual: <strong id="box-budget"></strong></div>
    </form>
    <button onclick="txnModal.style.display='block'">Agregar Transacción</button>
    <table>
      <thead><tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Desc</th><th>Acción</th></tr></thead>
      <tbody id="txn-table-body"></tbody>
    </table>
  </section>

  <!-- Modal Transacción -->
  <div id="transaction-modal">
    <form id="transaction-form">
      <button type="button" onclick="txnModal.style.display='none'">Cerrar</button>
      <label>Tipo<select name="tipo"><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select></label>
      <label>Monto<input name="monto" type="number" step="0.01"/></label>
      <label>Desc<input name="descripcion"/></label>
      <button type="submit">Guardar</button>
    </form>
  </div>
</body>
</html>





